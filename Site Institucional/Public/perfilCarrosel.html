<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/carroseis.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Notable&family=Protest+Strike&display=swap"
    rel="stylesheet" />

  <title>Document</title>
</head>

<body onload="buscarPlaylist(), buscarMusicaAleatoria(), buscarMusicasRecentes()">
  <div class="div_esquerda_perfil">
    <div class="musicasProximo" id="musicasAleatorias">
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
      <div class="cardM">
        <img src="assets/imgs/playlistPage/snoop.png" alt="" class="imgCardP">
        <h1 class="tituloMusical">titulo</h1>
        <p class="desc">descrição...</p>
        <button class="salvar"></button>
        <p class="tempo">min <span id="tempoMin">02:35</span></p>
      </div>
    </div>

  </div>
  <div class="div_direita_perfil">
    <div class="div_carrosel_perfil">
      <div class="left">
        <img src="assets/imgs/playlistPage/codaboyz.svg" alt="">
      </div>
      <div class="right" id="musicasRecentesDiv">
        <div class="cardsMusicas">
          <img src="assets/imgs/playlistPage/Audio Wave.svg" alt="" class="imgIcon">
        </div>
        <div class="cardsMusicas">
          <img src="assets/imgs/playlistPage/Audio Wave.svg" alt="" class="imgIcon">
        </div>
        <div class="cardsMusicas">
          <img src="assets/imgs/playlistPage/Audio Wave.svg" alt="" class="imgIcon">
        </div>

      </div>

    </div>
    <div class="playlists_pessoais">

      <div class="cardsPlay" id="cardPlaylist">
        <div class="card">
          <img src="assets/imgs/playlistPage/snoopdog.svg" alt="">
          <h1 class="title" style="font-family: 'Protest Strike';">TITULO PLAYLIST</h1>
          <p class="desc" style="font-family: 'Sofia sans';">snoop dogg melhores músicas 2001’s</p>
          <a href="#" class="btnPlay"></a>
        </div>
        <div class="card">
          <img src="assets/imgs/playlistPage/snoopdog.svg" alt="">
          <h1 class="title" style="font-family: 'Protest Strike';">TITULO PLAYLIST</h1>
          <p class="desc" style="font-family: 'Sofia sans';">snoop dogg melhores músicas 2001’s</p>
          <a href="#" class="btnPlay"></a>
        </div>
        <div class="card">
          <img src="assets/imgs/playlistPage/snoopdog.svg" alt="">
          <h1 class="title" style="font-family: 'Protest Strike';">TITULO PLAYLIST</h1>
          <p class="desc" style="font-family: 'Sofia sans';">snoop dogg melhores músicas 2001’s</p>
          <a href="#" class="btnPlay"></a>
        </div>
        <div class="card">
          <img src="assets/imgs/playlistPage/snoopdog.svg" alt="">
          <h1 class="title" style="font-family: 'Protest Strike';">TITULO PLAYLIST</h1>
          <p class="desc" style="font-family: 'Sofia sans';">snoop dogg melhores músicas 2001’s</p>
          <a href="#" class="btnPlay"></a>
        </div>
      </div>
      <div class="adicionarPlayList">

      </div>

    </div>
  </div>
</body>

</html>
<script>
  var idUsuario = sessionStorage.ID_USUARIO;
  var carroselMusicas = []

  var token = sessionStorage.TOKEN

  function cadastrarPlaylist() {
    var nomePlaylist = input_nome.value;

    if (nomePlaylist == ``) {
      div_mensagem.innerHTML = `Preencha todos os campos`
    } else if (nomePlaylist.length > 30) {
      div_mensagem.innerHTML = `O nomePlaylist pode ter no maximo 30 letras`
    } else if (nomePlaylist.length < 3) {
      div_mensagem.innerHTML = `A senha deve conter pelo menos 3 caracteres`
    } else if (idUsuario == undefined) {
      div_mensagem.innerHTML = `É necessário estar logado para criar uma playlist`
    } else {
      fetch("/perfilRoute/cadastrarPlaylist", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          usuarioServer: idUsuario,
          nomePlaylistServer: nomePlaylist
        })
      }).then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!")

        if (resposta.ok) {
          console.log(resposta);

          resposta.json().then(json => {
            console.log(json);
            console.log(JSON.stringify(json));
            alert(`Cadastro de playlist - sucrsso`)
            window.location = "./perfil.html"
          });

        } else {
          console.log("Houve um erro ao tentar realizar o login!")
          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })
    }
  }

  function buscarPlaylist() {
    fetch(`/perfilRoute/buscarPlaylist?pkUsuario=${idUsuario}`, {
      method: "GET"
    })
      .then(response => response.json())
      .then(playlist => {
        console.log(playlist)
        cardPlaylist.innerHTML = ''
        playlist.forEach(resultado => {
          cardPlaylist.innerHTML += `
                    <div class="card">
          <img src="${resultado.imagem_playlist}" alt="">
          <h1 class="title" style="font-family: 'Protest Strike';">${resultado.nome}</h1>
          <p class="desc" style="font-family: 'Sofia sans';">${resultado.descricao}</p>
          <a href="#" class="btnPlay"></a>
        </div>
                    `
        })
      })
  }

  function redirecionarPagina(idPlaylist) {
    sessionStorage.PLAYLIST = idPlaylist
    window.location.href = `playlist.html`
  }

  function buscarMusicasRecentes() {
    fetch(`/perfilRoute/buscarMusicasRecentes?pkUsuario=${idUsuario}`, {
      method: "GET"
    })
      .then(response => response.json())
      .then(musicasRecentes => {
        console.log(musicasRecentes)
        musicasRecentes.forEach(resultado => {

          fetch(`https://api.spotify.com/v1/tracks/${resultado.idSpotify}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          })
            .then(res => res.json())
            .then(dados => {
              musicasRecentesDiv.innerHTML = ''
              var musicas = dados.tracks.items

              if (dados.length >= 1) {
                for (var i = 0; i < musicas.length; i++) {
                  var musica = musicas[i]

                  var nome = musica.name
                  var imagem = musica.album.images[0].url
                  var uri = musica.uri
                  var artista = musica.artists

                  musicasRecentesDiv.innerHTML += `
                <div class="cardsMusicas">
                  <img src="${imagem}" alt="" class="imgIcon">
                </div>
                `
                }
              }
            })
            .catch(function (erro) {
              console.log(erro)
              resultado.innerHTML = "<p>Erro na busca.</p>"
            })
        })
      })
  }

  window.onSpotifyWebPlaybackSDKReady = () => {
    var player = new Spotify.Player({
      name: 'Player Web',
      getOAuthToken: cb => cb(token)
    })

    player.addListener('ready', e => {
      deviceId = e.device_id
      console.log('Player pronto:', deviceId)
    })

    player.connect()
  }

  function tocar(uri) {
    if (!deviceId) {
      alert('Player não está pronto. Aguarde...')
      return
    }

    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
      method: 'PUT',
      body: JSON.stringify({ uris: [uri] }),
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    })
  }

  // funções bob IA
  function copiarResposta() {
    var respostaDiv = document.getElementById('resposta');

    var texto = respostaDiv.innerText;

    navigator.clipboard.writeText(texto)
  }

  function sair() {

    sessionStorage.clear()
    window.location = "../index.html"
  }

  async function gerarResposta() {
    const pergunta = document.getElementById('pergunta');
    const respostaDiv = document.getElementById('resposta');
    respostaDiv.innerText = '';

    const response = await fetch('/perguntar/pergunta', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ pergunta: pergunta.value })
    });

    const data = await response.json()
    const texto = data.resultado;

    resposta.style.display = 'block'
    var html = ''
    pergunta.value = ``

    for (var i = 0; i < texto.length; i++) {

      html += texto[i]

      respostaDiv.innerHTML = html;
      await new Promise(resolve => setTimeout(resolve, 30))
    }
  }

  function buscarMusicaAleatoria() {
    musicasAleatorias.innerHTML = ''
    fetch(`/perfilRoute/buscarMusicasAleatoria`, {
      method: "GET"
    })
      .then(response => response.json())
      .then(dados => {
        dados.forEach(resultado => {


          fetch(`https://api.spotify.com/v1/tracks/${resultado.idSpotify}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          })
            .then(res => res.json())
            .then(dadosSpotify => {
              var musicas = dadosSpotify.tracks.items

              if (dadosSpotify.length >= 1) {
                for (var i = 0; i < musicas.length; i++) {
                  var musica = musicas[i]

                  var nome = musica.name
                  var imagem = musica.album.images[0].url
                  var uri = musica.uri
                  var artista = musica.artists

                  musicasAleatorias.innerHTML += `
                <div class="cardM">
        <img src="${imagem}" alt="" class="imgCardP">
        <h1 class="tituloMusical">${nome}</h1>
      </div>
                `
                }
              }
            })
            .catch(function (erro) {
              console.log(erro)
              resultado.innerHTML = "<p>Erro na busca.</p>"
            })
        })
      })
  }
</script>