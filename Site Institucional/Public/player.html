<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Web Player</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; text-align:center; padding: 20px; }
    #track-info { margin: 20px; }
    button { margin: 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
    #searchResults {
      margin-top: 20px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .track-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      background: #222;
      padding: 10px;
      border-radius: 6px;
    }
    .track-item img {
      width: 64px;
      height: 64px;
      margin-right: 15px;
      border-radius: 4px;
    }
    .track-info {
      flex: 1;
    }
    audio {
      margin-left: 10px;
      outline: none;
    }
    #searchContainer {
      margin-top: 30px;
      margin-bottom: 10px;
    }
    #searchInput {
      padding: 8px;
      font-size: 16px;
      width: 300px;
      border-radius: 4px;
      border: none;
    }
    #searchBtn {
      padding: 9px 15px;
      font-size: 16px;
      margin-left: 8px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #1db954;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Spotify Web Player</h1>

  <div id="track-info">Carregando...</div>
  <button id="prev">⏮️ Anterior</button>
  <button id="play">▶️ Tocar</button>
  <button id="pause" style="display:none;">⏸️ Pausar</button>
  <button id="next">⏭️ Próximo</button>

  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Digite o nome da música" />
    <button id="searchBtn">Buscar</button>
  </div>

  <div id="searchResults"></div>

  <script>
    // Função para pegar o token do hash da URL
    function getTokenFromUrl() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    const token = getTokenFromUrl();

    if (!token) {
      document.getElementById('track-info').textContent = 'Token não encontrado. Por favor, faça login novamente.';
    } else {
      // Salva o token no localStorage para outras funções, se quiser
      localStorage.setItem('access_token', token);

      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Meu Web Player',
          getOAuthToken: cb => { cb(token); },
          volume: 0.5
        });

        player.addListener('initialization_error', ({ message }) => { console.error('Erro na inicialização:', message); });
        player.addListener('authentication_error', ({ message }) => {
          console.error('Erro de autenticação:', message);
          document.getElementById('track-info').textContent = 'Erro de autenticação, faça login novamente.';
        });
        player.addListener('account_error', ({ message }) => { console.error('Erro conta:', message); });
        player.addListener('playback_error', ({ message }) => { console.error('Erro playback:', message); });

        player.addListener('player_state_changed', state => {
          if (!state) {
            document.getElementById('track-info').textContent = 'Nenhuma música tocando';
            return;
          }
          const currentTrack = state.track_window.current_track;
          document.getElementById('track-info').textContent = `${currentTrack.name} — ${currentTrack.artists.map(a => a.name).join(', ')}`;
          if (state.paused) {
            document.getElementById('play').style.display = 'inline-block';
            document.getElementById('pause').style.display = 'none';
          } else {
            document.getElementById('play').style.display = 'none';
            document.getElementById('pause').style.display = 'inline-block';
          }
        });

        player.addListener('ready', ({ device_id }) => {
          console.log('Pronto com device ID', device_id);
          fetch('https://api.spotify.com/v1/me/player', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              device_ids: [device_id],
              play: false
            }),
          }).then(() => {
            console.log('Playback transferido para o player da web');
          }).catch(console.error);
        });

        player.addListener('not_ready', ({ device_id }) => {
          console.log('Player ficou offline', device_id);
        });

        player.connect();

        document.getElementById('play').onclick = () => player.resume().catch(console.error);
        document.getElementById('pause').onclick = () => player.pause().catch(console.error);
        document.getElementById('next').onclick = () => player.nextTrack().catch(console.error);
        document.getElementById('prev').onclick = () => player.previousTrack().catch(console.error);
      };

      // Carrega o SDK do Spotify
      const script = document.createElement('script');
      script.src = "https://sdk.scdn.co/spotify-player.js";
      document.body.appendChild(script);

      // Função para buscar músicas
      function searchTracks(query) {
        fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          const resultsDiv = document.getElementById('searchResults');
          if (!data.tracks || data.tracks.items.length === 0) {
            resultsDiv.innerHTML = '<p>Nenhuma música encontrada.</p>';
            return;
          }

          const tracks = data.tracks.items;
          resultsDiv.innerHTML = tracks.map(track => `
            <div class="track-item">
              <img src="${track.album.images[2]?.url || ''}" alt="Capa do álbum" />
              <div class="track-info">
                <strong>${track.name}</strong><br/>
                ${track.artists.map(artist => artist.name).join(', ')}
              </div>
              ${track.preview_url ? `<audio controls src="${track.preview_url}"></audio>` : ''}
            </div>
          `).join('');
        })
        .catch(err => {
          console.error('Erro na busca:', err);
          document.getElementById('searchResults').innerHTML = '<p>Erro ao buscar músicas.</p>';
        });
      }

      document.getElementById('searchBtn').addEventListener('click', () => {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return alert('Digite o nome da música.');
        searchTracks(query);
      });

      // Opcional: busca ao pressionar Enter na caixa de texto
      document.getElementById('searchInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('searchBtn').click();
        }
      });
    }
  </script>

</body>
</html>
